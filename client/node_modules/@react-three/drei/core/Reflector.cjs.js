"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("@babel/runtime/helpers/objectWithoutPropertiesLoose"),r=require("react"),i=require("react-three-fiber"),n=require("react-merge-refs"),a=require("three");require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/assertThisInitialized"),require("@babel/runtime/helpers/inheritsLoose"),require("@babel/runtime/helpers/defineProperty");var o=require("../materials/MeshReflectorMaterial.cjs.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=u(e),l=u(t),d=u(n);i.extend({MeshReflectorMaterial:o.MeshReflectorMaterial});var c=r.forwardRef((function(e,t){var n=e.mixBlur,o=void 0===n?0:n,u=e.mixStrength,c=void 0===u?.5:u,m=e.resolution,p=void 0===m?256:m,h=e.args,f=void 0===h?[1,1]:h,x=e.minDepthThreshold,M=void 0===x?.9:x,g=e.maxDepthThreshold,v=void 0===g?1:g,b=e.depthScale,T=void 0===b?0:b,S=e.depthToBlurRatioBias,w=void 0===S?.25:S,R=e.mirror,y=e.children,F=e.debug,B=void 0===F?0:F,D=e.distortion,W=void 0===D?1:D,q=e.distortionMap,V=l.default(e,["mixBlur","mixStrength","resolution","args","minDepthThreshold","maxDepthThreshold","depthScale","depthToBlurRatioBias","mirror","children","debug","distortion","distortionMap"]),j=i.useThree(),E=j.gl,P=j.scene,_=j.camera,L=r.useRef(null),G=r.useState((function(){return new a.Plane}))[0],I=r.useState((function(){return new a.Vector3}))[0],k=r.useState((function(){return new a.Vector3}))[0],z=r.useState((function(){return new a.Vector3}))[0],C=r.useState((function(){return new a.Matrix4}))[0],O=r.useState((function(){return new a.Vector3(0,0,-1)}))[0],U=r.useState((function(){return new a.Vector4}))[0],A=r.useState((function(){return new a.Vector3}))[0],N=r.useState((function(){return new a.Vector3}))[0],H=r.useState((function(){return new a.Vector4}))[0],J=r.useState((function(){return new a.Matrix4}))[0],K=r.useState((function(){return new a.PerspectiveCamera}))[0],Q=r.useState((function(){for(var e=[],t={minFilter:a.LinearFilter,magFilter:a.LinearFilter,format:a.RGBFormat,encoding:E.outputEncoding},r=0;r<8;r++){var i=Math.max(8,Math.round(p/Math.pow(2,r))),n=new a.WebGLRenderTarget(i,i,t);n.texture.generateMipmaps=!1,e.push(n)}return e}))[0],X=r.useCallback((function(){if(k.setFromMatrixPosition(L.current.matrixWorld),z.setFromMatrixPosition(_.matrixWorld),C.extractRotation(L.current.matrixWorld),I.set(0,0,1),I.applyMatrix4(C),A.subVectors(k,z),!(A.dot(I)>0)){A.reflect(I).negate(),A.add(k),C.extractRotation(_.matrixWorld),O.set(0,0,-1),O.applyMatrix4(C),O.add(z),N.subVectors(k,O),N.reflect(I).negate(),N.add(k),K.position.copy(A),K.up.set(0,1,0),K.up.applyMatrix4(C),K.up.reflect(I),K.lookAt(N),K.far=_.far,K.updateMatrixWorld(),K.projectionMatrix.copy(_.projectionMatrix),J.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),J.multiply(K.projectionMatrix),J.multiply(K.matrixWorldInverse),J.multiply(L.current.matrixWorld),G.setFromNormalAndCoplanarPoint(I,k),G.applyMatrix4(K.matrixWorldInverse),U.set(G.normal.x,G.normal.y,G.normal.z,G.constant);var e=K.projectionMatrix;H.x=(Math.sign(U.x)+e.elements[8])/e.elements[0],H.y=(Math.sign(U.y)+e.elements[9])/e.elements[5],H.z=-1,H.w=(1+e.elements[10])/e.elements[14],U.multiplyScalar(2/U.dot(H)),e.elements[2]=U.x,e.elements[6]=U.y,e.elements[10]=U.z+1,e.elements[14]=U.w}}),[_.far,_.matrixWorld,_.projectionMatrix,z,U,O,I,H,G,k,C,N,J,A,K]),Y=r.useMemo((function(){var e={minFilter:a.LinearFilter,magFilter:a.LinearFilter,format:a.RGBFormat,encoding:E.outputEncoding},t=new a.WebGLRenderTarget(p,p,e);T>0&&(t.depthBuffer=!0,t.depthTexture=new a.DepthTexture(p,p),t.depthTexture.format=a.DepthFormat,t.depthTexture.type=a.UnsignedShortType);var r=Q.reduce((function(e,t,r){return e["u_mipmap_"+r]=t.texture,e["u_mipmap_res_"+r]=new a.Vector2(t.width,t.height),e}),{});return[t,s.default({mirror:R,textureMatrix:J,mixBlur:o,tDiffuse:t.texture,tDepth:t.depthTexture,mixStrength:c,minDepthThreshold:M,maxDepthThreshold:v,depthScale:T,depthToBlurRatioBias:w,debug:B,distortion:W,distortionMap:q,"defines-USE_DEPTH":T>0?"":void 0,"defines-USE_DISTORTION":q?"":void 0},r)]}),[E,J,p,R,o,c,M,v,T,w,B,W,q,Q]),Z=Y[0],$=Y[1];return i.useFrame((function(){(null==L?void 0:L.current)&&(L.current.visible=!1,X(),E.setRenderTarget(Z),E.state.buffers.depth.setMask(!0),E.render(P,K),0!==o&&Q.forEach((function(e){E.setRenderTarget(e),E.state.buffers.depth.setMask(!0),E.render(P,K)})),L.current.visible=!0,E.setRenderTarget(null))})),r.createElement("mesh",s.default({ref:d.default([L,t])},V),r.createElement("planeBufferGeometry",{args:f}),y?y("meshReflectorMaterial",$):r.createElement("meshReflectorMaterial",$))}));exports.Reflector=c;
